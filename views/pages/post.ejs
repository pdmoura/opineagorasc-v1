<!doctype html>
<html lang="pt-BR">
	<head>
		<%- include('../partials/head', { 
			title: post.title + ' - Opine Agora SC',
			description: post.excerpt || 'Portal de not√≠cias de Santa Catarina com foco em informa√ß√£o local, pol√≠tica, economia e opini√£o.',
			image: post.image || '',
			url: 'http://localhost:3000/post/' + post.id
		}) %>
	</head>
	<body>
		<%- include('../partials/header') %>

		<!-- POST CONTENT -->
		<main class="main-container" style="margin-top: 40px;">
			<article class="post-view-body" style="max-width: 800px; margin: 0 auto; padding: 0 20px;">
				<span class="post-view-category"><%= post.category %></span>
				<h1 class="post-view-title" style="font-size: 2.5rem; margin-top: 16px; margin-bottom: 24px;"><%= post.title %></h1>
				
				<div class="post-view-meta" style="display: flex; align-items: center; gap: 12px; margin-bottom: 32px; color: var(--text-secondary); font-size: 0.9rem;">
					<span>Por <strong><%= post.author %></strong></span>
					<span>‚Ä¢</span>
					<span><%= new Date(post.date).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' }) %></span>
				</div>

				<div class="post-view-text" id="postContent">
					<%- postContent %>
				</div>

				<div class="post-share" style="margin-top: 40px; padding: 24px 0; border-top: 1px solid var(--medium-gray, #e0e0e0); border-bottom: 1px solid var(--medium-gray, #e0e0e0); display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
					<strong style="font-family: 'Montserrat', sans-serif; font-size: 1.1rem; color: var(--text-primary);">Compartilhe:</strong>
					
					<a href="https://api.whatsapp.com/send?text=<%= encodeURIComponent(post.title + ' \n\n ' + url) %>" target="_blank" rel="noopener noreferrer" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background-color: #25D366; color: white; border-radius: 50%; text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'" title="Compartilhar no WhatsApp">
						<svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
					</a>
					<a href="https://www.facebook.com/sharer.php?u=<%= encodeURIComponent(url) %>" target="_blank" rel="noopener noreferrer" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background-color: #1877F2; color: white; border-radius: 50%; text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'" title="Compartilhar no Facebook">
						<svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.469h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.469h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
					</a>
					<a href="https://twitter.com/intent/tweet?text=<%= encodeURIComponent(post.title) %>&url=<%= encodeURIComponent(url) %>" target="_blank" rel="noopener noreferrer" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background-color: #000000; color: white; border-radius: 50%; text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'" title="Compartilhar no X">
						<svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg>
					</a>
					<a href="https://telegram.me/share/url?url=<%= encodeURIComponent(url) %>&text=<%= encodeURIComponent(post.title) %>" target="_blank" rel="noopener noreferrer" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background-color: #0088cc; color: white; border-radius: 50%; text-decoration: none; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'" title="Compartilhar no Telegram">
						<svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
					</a>
				</div>

				<!-- Approved Comments Display -->
				<% if (typeof comments !== 'undefined' && comments.length > 0) { %>
					<div class="post-comments-list" style="margin-top: 40px; margin-bottom: 40px;">
						<h3 style="font-family: 'Montserrat', sans-serif; font-size: 1.5rem; margin-bottom: 24px; color: var(--text-primary);">üí¨ Coment√°rios (<%= comments.length %>)</h3>
						<% comments.forEach(function(comment) { %>
							<div style="padding: 20px; background: #f9f9f9; border-radius: 8px; margin-bottom: 16px; border-left: 3px solid var(--teal-primary);">
								<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
									<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--teal-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1rem;">
										<%= comment.name.charAt(0).toUpperCase() %>
									</div>
									<div>
										<div style="font-weight: 600; color: var(--text-primary);"><%= comment.name %></div>
										<div style="font-size: 0.85rem; color: var(--text-secondary);">
											<%= new Date(comment.created_at).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
										</div>
									</div>
								</div>
								<p style="color: var(--text-secondary); line-height: 1.6; margin: 0;"><%= comment.content %></p>
							</div>
						<% }); %>
					</div>
				<% } %>

				<!-- Comment Form -->
				<div class="post-comments" style="margin-top: 40px; margin-bottom: 20px;">
					<h3 style="font-family: 'Montserrat', sans-serif; font-size: 1.5rem; margin-bottom: 8px; color: var(--text-primary);">Deixe sua resposta</h3>
					<p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 24px;">O seu endere√ßo de e-mail n√£o ser√° publicado. Campos obrigat√≥rios s√£o marcados com *</p>
					
					<form id="commentForm" style="display: flex; flex-direction: column; gap: 16px;">
						<div style="display: flex; gap: 16px; flex-wrap: wrap;">
							<div style="flex: 1; min-width: 200px;">
								<label style="display: block; font-size: 0.9rem; margin-bottom: 8px; font-weight: 500;">Nome *</label>
								<input 
									type="text" 
									id="commentName" 
									required 
									minlength="2" 
									maxlength="100"
									placeholder="Seu nome"
									style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; font-size: 1rem;">
							</div>
							<div style="flex: 1; min-width: 200px;">
								<label style="display: block; font-size: 0.9rem; margin-bottom: 8px; font-weight: 500;">E-mail *</label>
								<input 
									type="email" 
									id="commentEmail" 
									required 
									maxlength="255"
									placeholder="seu@email.com"
									style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; font-size: 1rem;">
							</div>
						</div>
						<div>
							<label style="display: block; font-size: 0.9rem; margin-bottom: 8px; font-weight: 500;">Coment√°rio *</label>
							<textarea 
								id="commentText" 
								rows="5" 
								required 
								minlength="10" 
								maxlength="2000"
								placeholder="Escreva seu coment√°rio aqui..."
								style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; font-size: 1rem; resize: vertical;"></textarea>
						</div>
						<button type="submit" id="commentSubmitBtn" style="align-self: flex-start; padding: 12px 32px; background-color: var(--teal-primary, #008080); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Publicar coment√°rio</button>
					</form>
				</div>

				<div style="margin-top: 48px; padding-top: 24px;">
					<a href="/" class="btn" style="display: inline-block; padding: 12px 24px; background: var(--teal-primary); color: white; text-decoration: none; border-radius: var(--radius-sm);">‚Üê Voltar para o in√≠cio</a>
				</div>
			</article>
		</main>

		<%- include('../partials/footer') %>

		<!-- Comment Submission Script -->
		<script type="module">
			// Import showToast from utils
			import { showToast } from '/js/modules/utils.js';

			const form = document.getElementById('commentForm');
			const nameInput = document.getElementById('commentName');
			const emailInput = document.getElementById('commentEmail');
			const contentInput = document.getElementById('commentText');
			const submitBtn = document.getElementById('commentSubmitBtn');

			// Client-side validation functions
			function validateName(name) {
				if (!name || name.trim().length < 2) {
					return 'O nome deve ter pelo menos 2 caracteres.';
				}
				if (name.trim().length > 100) {
					return 'O nome deve ter no m√°ximo 100 caracteres.';
				}
				return null;
			}

			function validateEmail(email) {
				if (!email || email.trim().length === 0) {
					return 'O e-mail √© obrigat√≥rio.';
				}
				const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
				if (!emailRegex.test(email)) {
					return 'Por favor, insira um e-mail v√°lido.';
				}
				if (email.length > 255) {
					return 'O e-mail √© muito longo.';
				}
				return null;
			}

			function validateContent(content) {
				if (!content || content.trim().length < 10) {
					return 'O coment√°rio deve ter pelo menos 10 caracteres.';
				}
				if (content.trim().length > 2000) {
					return 'O coment√°rio deve ter no m√°ximo 2000 caracteres.';
				}
				return null;
			}

			// Add character counter for comment field
			const charCounter = document.createElement('div');
			charCounter.style.cssText = 'font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px; text-align: right;';
			contentInput.parentElement.appendChild(charCounter);

			function updateCharCounter() {
				const length = contentInput.value.trim().length;
				const remaining = 2000 - length;
				charCounter.textContent = `${length}/2000 caracteres`;
				if (length < 10) {
					charCounter.style.color = '#e74c3c';
				} else if (remaining < 100) {
					charCounter.style.color = '#f39c12';
				} else {
					charCounter.style.color = 'var(--text-secondary)';
				}
			}

			contentInput.addEventListener('input', updateCharCounter);
			updateCharCounter();

			// Form submission
			form.addEventListener('submit', async function(e) {
				e.preventDefault();
				
				const name = nameInput.value;
				const email = emailInput.value;
				const content = contentInput.value;

				// Client-side validation
				const nameError = validateName(name);
				if (nameError) {
					showToast('‚ùå ' + nameError, 'error');
					nameInput.focus();
					return;
				}

				const emailError = validateEmail(email);
				if (emailError) {
					showToast('‚ùå ' + emailError, 'error');
					emailInput.focus();
					return;
				}

				const contentError = validateContent(content);
				if (contentError) {
					showToast('‚ùå ' + contentError, 'error');
					contentInput.focus();
					return;
				}

				// Disable button and show loading state
				const originalText = submitBtn.textContent;
				submitBtn.textContent = '‚è≥ Enviando...';
				submitBtn.disabled = true;
				
				const formData = {
					post_id: <%= post.id %>,
					name: name.trim(),
					email: email.trim(),
					content: content.trim()
				};
				
				try {
					const response = await fetch('/api/comments', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(formData)
					});
					
					const result = await response.json();
					
					if (response.ok) {
						showToast('‚úÖ Coment√°rio enviado para an√°lise!', 'success');
						form.reset();
						updateCharCounter();
					} else {
						// Show specific error from server
						showToast('‚ùå ' + (result.error || 'Erro ao enviar coment√°rio'), 'error');
					}
				} catch (error) {
					console.error('Error:', error);
					showToast('‚ùå Erro de conex√£o. Verifique sua internet e tente novamente.', 'error');
				} finally {
					submitBtn.textContent = originalText;
					submitBtn.disabled = false;
				}
			});
		</script>

		<% if (typeof isDev !== 'undefined' && isDev) { %>
			<script type="module" src="http://localhost:5173/@vite/client"></script>
			<script type="module" src="http://localhost:5173/js/main-public.js"></script>
		<% } else { %>
			<script type="module" src="/dist/js/main-public.js"></script>
		<% } %>
	</body>
</html>
